<html>
    <head>
        <h1>FPID Demo</h1>

        <script type="text/javascript">
            window.digitalData = {
                "page": {
                    "pageInfo": {
                        "pageShortName": "fpid:en",
                        "pageName": "FPID Demo Home Page",
                        "destinationURL": "https://websdkdemo.github.io/fpiddemo/FPID_Demo.html",
                        "isIframe": false,
                        "contentIframe": false,
                        "hierarchiel": "fpidmaindemo:us:en",
                        "title": "WebSDK Demos: FPID",
                        "internalPageName": "en",
                        "tagging": "",
                        "server": "websdkdemo.github.io",
                        "urlShortcut": ""
                    },
                    "category": {
                        "type": "demo:fpid",
                        "version": "2023-06-19"
                    },
                    "attributes": {},
                    "components": []
                },
                "product": [
                    {
                        "productInfo": {}
                    }
                ],
                "user": [
                    {
                        "profile": [
                            {
                                "profileInfo": {},
                                "attributes": {
                                    "loggedIn": false
                                }
                            }
                        ]
                    }
                ],
                "language": "en"
            };
        </script>

        <link rel="stylesheet" type="text/css" href="css/style.css" />
        <script src="https://assets.adobedtm.com/22bf1a13013f/45c48148f3db/launch-3bb83e881f0c-development.min.js" async></script>
        <script type="text/javascript">

            var index,fpidArray,ecidArray,prevECID;
            index = -1;
            fpidArray = [];
            ecidArray = [];
            prevECID = "";

            function getUUID() {
                return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                    );
            }

            function generateUUID() {
                var fpidValue = getUUID();
                if(cbFPID.checked == 1) {
                    document.getElementById("fpidValue").innerHTML = "FPID Value: " + fpidValue;
                } else {
                    document.getElementById("fpidValue").innerHTML = "FPID Value: " + fpidValue;
                    //document.getElementById("fpidValue").innerHTML = "FPID Value: Not enabled yet";
                }
                var curECID = retrieveECID();
                if(prevECID != curECID) {
                    index++;
                    ecidArray[index] = curECID;
                    prevECID = curECID;
                }
                
                generateTable();
                _satellite.setCookie("FPID","Value-1",100);
                //setCookie("FPID","value-1");
            }
            window.onload = generateUUID;

            function retrieveECID() {
                var ecid = "";
                var cookieValue = _satellite.cookie.get("AMCV_53A16ACB5CC1D3760A495C99@AdobeOrg");
                if(cookieValue.includes('MCMID')) {
                    ecid = cookieValue.split('MCMID|')[1];
                    ecid = ecid.split('|')[0];
                }
                return ecid;
            }

            function reload() {
                if(cbFPID.checked == 1) {
                    document.getElementById("iframe").src = "Launch_Demo.html";
                } else {
                    document.getElementById("iframe").src = "PreLaunch_Demo.html";
                }
                generateTable();
            }

            function generateTable() {
                
                let table = document.querySelector("table");
                table.innerHTML = "";
                
                // Table Head
                let thead = table.createTHead();
                let row = thead.insertRow();
                let th = document.createElement("th");
                let text = document.createTextNode("Visitor Count");
                th.appendChild(text);
                row.appendChild(th);

                th = document.createElement("th");
                text = document.createTextNode("FPID");
                th.appendChild(text);
                row.appendChild(th);

                th = document.createElement("th");
                text = document.createTextNode("ECID");
                th.appendChild(text);
                row.appendChild(th);

                let tbody = table.createTBody();
                let fpid = "", ecid = "";
                // Table Rows
                for(let i = 0; i <= index; i++) {
                    row = tbody.insertRow();

                    td = document.createElement("td");
                    text = document.createTextNode(i+1);
                    td.appendChild(text);
                    row.appendChild(td);

                    td = document.createElement("td");
                    fpid = fpidArray[index];
                    if(!fpid) {
                        fpid = "";
                    }
                    text = document.createTextNode(fpid);
                    td.appendChild(text);
                    row.appendChild(td);

                    td = document.createElement("td");
                    ecid = ecidArray[index];
                    if(!ecid) {
                        ecid = "";
                    }
                    text = document.createTextNode(ecid);
                    td.appendChild(text);
                    row.appendChild(td);
                }
            }

            function getCookie(name) {
                var dc = document.cookie;
                var prefix = name + "=";
                var begin = dc.indexOf("; " + prefix);
                if (begin == -1) {
                    begin = dc.indexOf(prefix);
                    if (begin != 0) return null;
                }
                else
                {
                    begin += 2;
                    var end = document.cookie.indexOf(";", begin);
                    if (end == -1) {
                    end = dc.length;
                    }
                }
                // because unescape has been deprecated, replaced with decodeURI
                //return unescape(dc.substring(begin + prefix.length, end));
                return decodeURI(dc.substring(begin + prefix.length, end));
            } 

            function setCookie(cname, cvalue) {
                
                let d = getTimeStampAfter2Years();
                let expires = "expires="+ d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";domain=example.com;Secure;" + expires;
            }

            function createOrUpdateCookie() {
                var fpidValue = getCookie("FPID");
                if(!!fpidValue) {
                    console.log("FPID Cookie exists with value " + fpidValue);
                } else {
                    fpidValue = getUUID();
                    console.log("FPID Cookie created with value " + fpidValue);
                }
                setCookie("FPID", fpidValue);
            }

            function getPastTimeStamp() {
                var d = new Date();
                return new Date(d.getFullYear()-1, d.getMonth(), d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds(), d.getMilliseconds());
            }

            function getTimeStampAfter2Years() {
                var d = new Date();
                return new Date(d.getFullYear()+2, d.getMonth(), d.getDate(), d.getHours(), d.getMinutes(), d.getSeconds(), d.getMilliseconds());
            }

            function clearAllCookies() {
                var cookies = document.cookie.split(";");
                var cookie, eqPos, name;
                for (let i = 0; i < cookies.length; i++) {
                    cookie = cookies[i];
                    eqPos = cookie.indexOf("=");
                    name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                    name = name.trim();
                    document.cookie = name + "=; Path=/; domain=.websdkdemo.github.io; expires="
                        + new Date(0).toUTCString();
                }
                document.getElementById("recentChange").innerHTML = "Cleared all cookies...";
            }

            function clearAllCookiesExceptFPID() {
                var cookies = document.cookie.split(";");
                var cookie, eqPos, name;
                for (let i = 0; i < cookies.length; i++) {
                    cookie = cookies[i];
                    eqPos = cookie.indexOf("=");
                    name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                    name = name.trim();
                    if(name != "FPID") {
                        document.cookie = name + "=; Path=/; domain=.websdkdemo.github.io; expires="
                            + new Date(0).toUTCString();
                    }
                }
                document.getElementById("recentChange").innerHTML = "Cleared all cookies except FPID...";
            }

        </script>
    </head>
    <body>
        <input type="checkbox" id="cbFPID" name="cbFPID" onclick="reload()"><label for="cbFPID">Is FPID Launched?</label><br><br>
        <div id="fpidValue"></div><br>
        ECID Value: <div id="ecidValue"></div><br>

        <br><br>

        Recent Change: 
        <br>
        <div id="recentChange"></div>

        <div class="float-container">
            <div class="float-child1">
                <iframe src="PreLaunch_Demo.html" id="iframe"  class="iFrameContainer" frameborder="1"></iframe>
                <br><br>
                <input type="button" id="refreshButton" value="Refresh" onclick="reload()" />
                <input type="button" id="clearAllCookiesButton" value="Clear All Cookies" onclick="clearAllCookies()" />
                <input type="button" id="clearCookiesExceptFPIDButton" value="Clear Cookies Except FPID" onclick="clearAllCookiesExceptFPID()" />
                <br><br>
                
            </div>
            <div class="float-child2">
                <table class="styled-table"></table>
            </div>
        </div>

        <br><br>


<!--        
        <br/>
        
        <div>
            <a href="PreLaunch_Demo.html" target="iframe">Link to Pre-Launch State</a><br />
            <a href="Launch_Demo.html" target="iframe">Link to Launch State</a>
        </div>
        <br><br>
-->
  
        <script>
            //function reload() {
            //    document.getElementById("iframe").src = "PreLaunch_Demo.html";
            //}
            //refreshButton.onclick = reload;
        </script>
    </body>
</html>
